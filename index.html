<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>刷題系統</title>
<style>
body { font-family: Arial; max-width: 800px; margin: auto; }
.question { margin: 20px 0; }
.choice { margin: 5px 0; }
button { margin: 10px 5px; padding: 8px 16px; }

label.option {
  display: block;
  padding: 8px 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin: 6px 0;
}

label.option.is-correct {
  background: #dcfce7;
  border-color: #16a34a;
}

label.option.is-wrong {
  background: #fee2e2;
  border-color: #dc2626;
}
</style>
</head>
<body>

<h1>刷題系統</h1>

<div style="margin: 10px 0;">
  <label for="numQuestions"><b>每次題數：</b></label>
  <select id="numQuestions">
    <option value="10" selected>10 題</option>
    <option value="15">15 題</option>
    <option value="20">20 題</option>
    <option value="25">25 題</option>
  </select>
</div>

<div id="quiz"></div>
<button id="submitBtn" onclick="submitQuiz()">送出</button>
<button onclick="nextRound()">下一次測驗</button>

<script>
const QUESTIONS = window.QUESTIONS || []; // GitHub 上的題庫仍在原本位置

function loadStats() {
  return JSON.parse(localStorage.getItem("stats") || "{}");
}
function saveStats(stats) {
  localStorage.setItem("stats", JSON.stringify(stats));
}

let current = [];

function getNumQuestions() {
  return parseInt(document.getElementById("numQuestions").value, 10);
}

function weightedSampleUnique(arr, n) {
  const stats = loadStats();
  const pool = arr.map(q => ({
    q,
    w: 1 + (stats[q.id]?.wrong || 0)
  }));

  const res = [];
  while (res.length < n && pool.length > 0) {
    const total = pool.reduce((s, x) => s + x.w, 0);
    let r = Math.random() * total;

    let idx = 0;
    for (; idx < pool.length; idx++) {
      r -= pool[idx].w;
      if (r <= 0) break;
    }

    res.push(pool[idx].q);
    pool.splice(idx, 1);
  }
  return res;
}

function render() {
  const n = getNumQuestions();
  current = weightedSampleUnique(QUESTIONS, n);

  const div = document.getElementById("quiz");
  div.innerHTML = "";

  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = false;

  current.forEach((q,i) => {
    div.innerHTML += `
      <div class="question" data-qindex="${i}">
        <b>${i+1}. ${q.question}</b><br>
        ${q.choices.map((c,idx)=>`
          <div class="choice">
            <label class="option">
              <input type="radio" name="q${i}" value="${idx}"> ${c}
            </label>
          </div>`).join("")}
      </div>`;
  });
}

function markOptions(qIndex, correct, selected) {
  const qEl = document.querySelector(\`.question[data-qindex="\${qIndex}"]\`);
  if (!qEl) return;

  qEl.querySelectorAll("label.option").forEach(label => {
    const input = label.querySelector("input");
    const v = Number(input.value);

    if (v === correct) label.classList.add("is-correct");
    if (v === selected && selected !== correct) label.classList.add("is-wrong");
  });
}

function submitQuiz() {
  const stats = loadStats();

  current.forEach((q,i)=>{
    const sel = document.querySelector(\`input[name=q\${i}]:checked\`);
    const ans = sel ? Number(sel.value) : -1;

    if (!stats[q.id]) stats[q.id] = { wrong:0 };
    if (ans !== q.answer) stats[q.id].wrong++;

    markOptions(i, q.answer, ans);
  });

  saveStats(stats);

  document.querySelectorAll('#quiz input[type="radio"]').forEach(r => r.disabled = true);
  document.getElementById("submitBtn").disabled = true;
}

function nextRound() {
  render();
}

document.getElementById("numQuestions").addEventListener("change", nextRound);

render();
</script>

</body>
</html>
